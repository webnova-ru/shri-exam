/*!
 * CanJS - 1.1.8
 * http://canjs.us/
 * Copyright (c) 2013 Bitovi
 * Tue, 24 Sep 2013 21:59:56 GMT
 * Licensed MIT
 * Includes: can/util/fixture
 * Download from: http://canjs.com
 */

!function(t){var e=function(e){return"undefined"!=typeof steal?t.isFunction(steal.config)?steal.config().root.mapJoin(e).toString():steal.root.join(e).toString():(t.fixture.rootUrl||"")+e},n=function(n,i){if(t.fixture.on){var a=function(){"undefined"!=typeof steal&&steal.dev&&steal.dev.log("fixture INFO: "+Array.prototype.slice.call(arguments).join(" "))};n.type=n.type||n.method||"GET";var r=u(n);if(!n.fixture)return"file:"===window.location.protocol&&a("ajax request to "+n.url+", no fixture found"),void 0;if("string"==typeof n.fixture&&t.fixture[n.fixture]&&(n.fixture=t.fixture[n.fixture]),"string"==typeof n.fixture){var o=n.fixture;/^\/\//.test(o)&&(o=e(n.fixture.substr(2))),r&&(o=t.sub(o,r)),delete n.fixture,n.url=o,n.data=null,n.type="GET",n.error||(n.error=function(t,e,n){throw"fixtures.js Error "+e+" "+n})}else n.dataTypes&&n.dataTypes.splice(0,0,"fixture"),r&&i&&t.extend(i.data,r)}},i=function(t,e,n,i){return"number"!=typeof t&&(i=e,n=t,e="success",t=200),"string"!=typeof e&&(i=n,n=e,e="success"),t>=400&&599>=t&&(this.dataType="text"),[t,e,a(this,n),i]},a=function(t,e){var n=t.dataTypes?t.dataTypes[0]:t.dataType||"json";if(!e||!e[n]){var i={};i[n]=e,e=i}return e};if(t.ajaxPrefilter&&t.ajaxTransport)t.ajaxPrefilter(n),t.ajaxTransport("fixture",function(e,n){e.dataTypes.shift();var r,o=!1;return{send:function(s,u){r=setTimeout(function(){var t=function(){o===!1&&u.apply(null,i.apply(e,arguments))},r=e.fixture(n,t,s,e);void 0!==r&&u(200,"success",a(e,r),{})},t.fixture.delay)},abort:function(){o=!0,clearTimeout(r)}}});else{var r=t.ajax;t.ajax=function(e){if(n(e,e),e.fixture){var a,o=new t.Deferred,s=!1;return o.getResponseHeader=function(){},o.then(e.success,e.fail),o.abort=function(){clearTimeout(a),s=!0,o.reject(o)},a=setTimeout(function(){var t=function(){var t=i.apply(e,arguments),n=t[0];(n>=200&&300>n||304===n)&&s===!1?o.resolve(t[2][e.dataType]):o.reject(o,"error",t[1])},n=e.fixture(e,t,e.headers,e);void 0!==n&&o.resolve(n)},t.fixture.delay),o}return r(e)}}var o=[],s=function(t,e){for(var n=0;n<o.length;n++)if(l._similar(t,o[n],e))return n;return-1},u=function(t){var e=s(t);return e>-1?(t.fixture=o[e].fixture,l._getData(o[e].url,t.url)):void 0},c=function(t){var e=t.data.id;return void 0===e&&"number"==typeof t.data&&(e=t.data),void 0===e&&t.url.replace(/\/(\d+)(\/|$|\.)/g,function(t,n){e=n}),void 0===e&&(e=t.url.replace(/\/(\w+)(\/|$|\.)/g,function(t,n){"update"!=n&&(e=n)})),void 0===e&&(e=Math.round(1e3*Math.random())),e},l=t.fixture=function(e,n){if(void 0!==n){if("string"==typeof e){var i=e.match(/(GET|POST|PUT|DELETE) (.+)/i);e=i?{url:i[2],type:i[1]}:{url:e}}var a=s(e,!!n);if(a>-1&&o.splice(a,1),null==n)return;e.fixture=n,o.push(e)}else t.each(e,function(t,e){l(e,t)})},d=t.replacer;return t.extend(t.fixture,{_similar:function(e,n,i){return i?t.Object.same(e,n,{fixture:null}):t.Object.subset(e,n,t.fixture._compare)},_compare:{url:function(t,e){return!!l._getData(e,t)},fixture:null,type:"i"},_getData:function(e,n){var i=[],a=e.replace(".","\\.").replace("?","\\?"),r=new RegExp(a.replace(d,function(t,e){return i.push(e),"([^/]+)"})+"$").exec(n),o={};return r?(r.shift(),t.each(i,function(t){o[t]=r.shift()}),o):null},store:function(e,n,i,a){var r=[],o=0,s=function(t){for(var e=0;e<r.length;e++)if(t==r[e].id)return r[e]},u={};"string"==typeof e?e=[e+"s",e]:t.isArray(e)||(a=i,i=n,n=e),t.extend(u,{findAll:function(e){e=e||{};var n=r.slice(0);e.data=e.data||{},t.each((e.data.order||[]).slice(0).reverse(),function(t){var e=t.split(" ");n=n.sort(function(t,n){return"ASC"!==e[1].toUpperCase()?t[e[0]]<n[e[0]]?1:t[e[0]]==n[e[0]]?0:-1:t[e[0]]<n[e[0]]?-1:t[e[0]]==n[e[0]]?0:1})}),t.each((e.data.group||[]).slice(0).reverse(),function(t){var e=t.split(" ");n=n.sort(function(t,n){return t[e[0]]>n[e[0]]})});var i=parseInt(e.data.offset,10)||0,o=parseInt(e.data.limit,10)||r.length-i,s=0;for(var u in e.data)if(s=0,void 0!==e.data[u]&&(-1!=u.indexOf("Id")||-1!=u.indexOf("_id")))for(;s<n.length;)e.data[u]!=n[s][u]?n.splice(s,1):s++;if(a)for(s=0;s<n.length;)a(n[s],e)?s++:n.splice(s,1);return{count:n.length,limit:e.data.limit,offset:e.data.offset,data:n.slice(i,i+o)}},findOne:function(t,e){var n=s(c(t));e(n?n:void 0)},update:function(e,n){var i=c(e);t.extend(s(i),e.data),n({id:c(e)},{location:e.url||"/"+c(e)})},destroy:function(e){for(var n=c(e),i=0;i<r.length;i++)if(r[i].id==n){r.splice(i,1);break}return t.extend(s(n)||{},e.data),{}},create:function(e,n){var a=i(r.length,r);t.extend(a,e.data),a.id||(a.id=o++),r.push(a),n({id:a.id},{location:e.url+"/"+a.id})}});var l=function(){r=[];for(var a=0;n>a;a++){var s=i(a,r);s.id||(s.id=a),o=Math.max(s.id+1,o+1)||r.length,r.push(s)}t.isArray(e)&&(t.fixture["~"+e[0]]=r,t.fixture["-"+e[0]]=u.findAll,t.fixture["-"+e[1]]=u.findOne,t.fixture["-"+e[1]+"Update"]=u.update,t.fixture["-"+e[1]+"Destroy"]=u.destroy,t.fixture["-"+e[1]+"Create"]=u.create)};return l(),t.extend({getId:c,find:function(t){return s(c(t))},reset:l},u)},rand:function(t,e,n){if("number"==typeof t)return"number"==typeof e?t+Math.floor(Math.random()*(e-t)):Math.floor(Math.random()*t);var i=arguments.callee;if(void 0===e)return i(t,i(t.length+1));var a=[];t=t.slice(0),n||(n=e),n=e+Math.round(i(n-e));for(var r=0;n>r;r++)a.push(t.splice(i(t.length),1)[0]);return a},xhr:function(e){return t.extend({},{abort:t.noop,getAllResponseHeaders:function(){return""},getResponseHeader:function(){return""},open:t.noop,overrideMimeType:t.noop,readyState:4,responseText:"",responseXML:null,send:t.noop,setRequestHeader:t.noop,status:200,statusText:"OK"},e)},on:!0}),t.fixture.delay=200,t.fixture.rootUrl=e(""),t.fixture["-handleFunction"]=function(e){return"string"==typeof e.fixture&&t.fixture[e.fixture]&&(e.fixture=t.fixture[e.fixture]),"function"==typeof e.fixture?(setTimeout(function(){e.success&&e.success.apply(null,e.fixture(e,"success")),e.complete&&e.complete.apply(null,e.fixture(e,"complete"))},t.fixture.delay),!0):!1},t.fixture.overwrites=o,t.fixture.make=t.fixture.store,t.fixture}(can);